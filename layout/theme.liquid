<!doctype html>
<html class="no-js" lang="{{ request.locale.iso_code }}">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, height=device-height, minimum-scale=1.0">
  <meta name="theme-color" content="{{ settings.color_primary }}">

  {%- comment -%} Resource Hints for Performance {%- endcomment -%}
  {%- render 'resource-hints' -%}

  {%- comment -%} PWA Support {%- endcomment -%}
  {%- render 'pwa-support' -%}

  {%- comment -%} Meta Tags for SEO and Social Sharing {%- endcomment -%}
  {%- render 'meta-tags' -%}

  {%- comment -%} Structured Data for SEO {%- endcomment -%}
  {%- render 'structured-data' -%}

  <title>
    {{ page_title }}
    {%- if current_tags %} &ndash; tagged "{{ current_tags | join: ', ' }}"{% endif -%}
    {%- if current_page != 1 %} &ndash; Page {{ current_page }}{% endif -%}
    {%- unless page_title contains shop.name %} &ndash; {{ shop.name }}{% endunless -%}
  </title>

  {%- if page_description -%}
    <meta name="description" content="{{ page_description | escape }}">
  {%- endif -%}

  {%- comment -%} Canonical URL {%- endcomment -%}
  {%- if settings.enable_canonical_url -%}
    <link rel="canonical" href="{{ canonical_url }}">
  {%- endif -%}

  {%- if settings.favicon -%}
    <link rel="icon" type="image/png" href="{{ settings.favicon | image_url: width: 32, height: 32 }}">
  {%- endif -%}

  {%- comment -%} Critical CSS for Performance {%- endcomment -%}
  {%- render 'critical-css' -%}

  {%- comment -%} Load base CSS asynchronously if enabled {%- endcomment -%}
  {%- if settings.enable_async_css -%}
    {% render 'css-loader', css: 'base.css' %}
  {%- else -%}
    {{ 'base.css' | asset_url | stylesheet_tag }}
  {%- endif -%}

  {%- comment -%} Shopify Font Loading - Load only fonts used by current preset {%- endcomment -%}
  {%- liquid
    # Get current preset
    assign preset = settings.theme_preset | default: 'the-welder'

    # Define fonts for each preset (heading:weights;body:weights)
    assign preset_fonts = ''
    case preset
      when 'the-welder', 'work-zone', 'bold-impact'
        assign preset_fonts = 'Oswald:500;700,Roboto:400;500;700'
      when 'site-ops'
        assign preset_fonts = 'Oswald:500;700,Work Sans:400;600;700'
      when 'midnight-shift'
        assign preset_fonts = 'Teko:500;600;700,Roboto:400;500;700'
      when 'precision'
        assign preset_fonts = 'IBM Plex Sans:400;500;600'
      when 'tactical'
        assign preset_fonts = 'Archivo Black:400,Roboto:400;500;700'
      when 'monolith', 'zebra-skimmers', 'tech-forward'
        assign preset_fonts = 'Inter:400;500;600'
      when 'modern-minimal'
        assign preset_fonts = 'Bitter:700;800,Roboto:400;500;700'
      when 'warm-artisan'
        assign preset_fonts = 'Bitter:700;800,Lato:400;700'
      when 'custom'
        if settings.font_heading.family
          assign preset_fonts = settings.font_heading.family | append: ':400;500;600;700'
        endif
        if settings.font_body.family
          if preset_fonts != blank
            assign preset_fonts = preset_fonts | append: ',' | append: settings.font_body.family | append: ':400;500;700'
          else
            assign preset_fonts = settings.font_body.family | append: ':400;500;700'
          endif
        endif
    endcase

    # Load fonts if available
    if preset_fonts != blank
      assign font_families = preset_fonts | split: ','
      for font_family in font_families
        assign font_parts = font_family | split: ':'
        assign font_name = font_parts[0]
        assign font_weights = font_parts[1] | default: '400'
        assign font_weights_array = font_weights | split: ';'
        for weight in font_weights_array
          assign font_face = font_name | font_face: weight: weight
          if font_face
            echo font_face | font_url | preload_tag: as: 'font', type: 'font/woff2', crossorigin: true
          endif
        endfor
      endfor
    endif
  -%}

  {%- comment -%} Font CSS Declarations {%- endcomment -%}
  <style>
    {%- if preset_fonts != blank -%}
      {%- assign font_families = preset_fonts | split: ',' -%}
      {%- for font_family in font_families -%}
        {%- assign font_parts = font_family | split: ':' -%}
        {%- assign font_name = font_parts[0] -%}
        {%- assign font_weights = font_parts[1] | default: '400' -%}
        {%- assign font_weights_array = font_weights | split: ';' -%}
        {%- for weight in font_weights_array -%}
          {%- assign font_face = font_name | font_face: weight: weight -%}
          {%- if font_face -%}
            {%- assign font_url_woff2 = font_face | font_url: font_format: 'woff2' -%}
            {%- assign font_url_woff = font_face | font_url: font_format: 'woff' -%}
            {%- assign font_style = font_face.style | default: 'normal' -%}
    @font-face {
      font-family: "{{ font_name }}";
      font-weight: {{ weight }};
      font-style: {{ font_style }};
      font-display: swap;
      src: url("{{ font_url_woff2 }}") format("woff2"),
           url("{{ font_url_woff }}") format("woff");
    }
          {%- endif -%}
        {%- endfor -%}
      {%- endfor -%}
    {%- endif -%}
  </style>

  {% render 'css-variables' %}

  {{ content_for_header }}

  {%- comment -%} Performance Monitor for testing and optimization {%- endcomment -%}
  <script src="{{ 'performance-monitor.js' | asset_url }}" defer></script>

  {%- comment -%} Performance Optimization Script {%- endcomment -%}
  <script>
    // Add no-js class removal and lazy loading initialization
    document.documentElement.classList.remove('no-js');
    document.documentElement.classList.add('js');

    // Initialize lazy loading if enabled
    {%- if settings.enable_lazy_loading -%}
    if ('IntersectionObserver' in window) {
      const lazyImages = document.querySelectorAll('img[data-src], img[data-srcset]');
      const imageObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const img = entry.target;
            if (img.dataset.src) {
              img.src = img.dataset.src;
              img.removeAttribute('data-src');
            }
            if (img.dataset.srcset) {
              img.srcset = img.dataset.srcset;
              img.removeAttribute('data-srcset');
            }
            if (img.dataset.sizes) {
              img.sizes = img.dataset.sizes;
              img.removeAttribute('data-sizes');
            }
            img.classList.remove('lazy');
            img.classList.add('loaded');
            observer.unobserve(img);
          }
        });
      }, {
        rootMargin: '50px 0px',
        threshold: 0.1
      });
      lazyImages.forEach(img => imageObserver.observe(img));
    } else {
      // Fallback for browsers without IntersectionObserver
      const lazyImages = document.querySelectorAll('img[data-src], img[data-srcset]');
      lazyImages.forEach(img => {
        if (img.dataset.src) {
          img.src = img.dataset.src;
          img.removeAttribute('data-src');
        }
        if (img.dataset.srcset) {
          img.srcset = img.dataset.srcset;
          img.removeAttribute('data-srcset');
        }
        if (img.dataset.sizes) {
          img.sizes = img.dataset.sizes;
          img.removeAttribute('data-sizes');
        }
        img.classList.remove('lazy');
        img.classList.add('loaded');
      });
    }
    {%- endif -%}

    // Performance monitoring
    if ('PerformanceObserver' in window) {
      const observer = new PerformanceObserver((list) => {
        const entries = list.getEntries();
        entries.forEach(entry => {
          if (entry.entryType === 'largest-contentful-paint') {
            console.log('LCP:', entry.startTime);
          }
        });
      });
      try {
        observer.observe({ entryTypes: ['largest-contentful-paint'] });
      } catch (e) {
        // Ignore if not supported
      }
    }

    // Service Worker registration for PWA
    {%- if settings.enable_pwa -%}
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/apps/sw.js', { scope: '/' })
          .then(registration => {
            console.log('SW registered:', registration.scope);
            // Mark service worker as available for performance tests
            window.serviceWorkerRegistered = true;
          })
          .catch(error => {
            console.log('SW registration failed:', error);
            window.serviceWorkerRegistered = false;
          });
      });
    }
    {%- endif -%}
  </script>
</head>

<body class="template-{{ template.name }}{% if template.suffix %} template-{{ template.name }}-{{ template.suffix }}{% endif %}">
  <a class="visually-hidden" href="#MainContent">Skip to content</a>

  {%- comment -%} PWA Install Banner {%- endcomment -%}
  {%- render 'pwa-install-banner' -%}

  {%- comment -%}
    Header Section Group
    Merchants can swap header variants (announcement-bar, header--classic, header--mega, etc.)
    directly from the theme editor. Each preset can configure its own header combination.
  {%- endcomment -%}
  {% sections 'header-group' %}

  <main id="MainContent" role="main" tabindex="-1">
    {{ content_for_layout }}
  </main>

  {%- comment -%}
    Footer Section Group
    Merchants can swap footer variants directly from the theme editor.
    Each preset can configure its own footer style.
  {%- endcomment -%}
  {% sections 'footer-group' %}

  {%- comment -%} Preset Showcase System {%- endcomment -%}
  {%- render 'preset-showcase' -%}

  {%- comment -%} JavaScript Loading in Footer (if setting enabled) {%- endcomment -%}
  {%- if settings.js_load_location == 'footer' or settings.js_load_location == blank -%}
    {%- liquid
      if settings.enable_optimized_js
        assign js_strategy = settings.js_loading_strategy
      else
        assign js_strategy = 'blocking'
      endif
    -%}

    {%- if js_strategy == 'defer' -%}
      <script src="{{ 'global.js' | asset_url }}" defer></script>
    {%- elsif js_strategy == 'async' -%}
      <script src="{{ 'global.js' | asset_url }}" async></script>
    {%- else -%}
      <script src="{{ 'global.js' | asset_url }}"></script>
    {%- endif -%}
  {%- endif -%}
</body>
</html>
