{% doc %}
  Enhanced Shoppable Image - Interactive product hotspots with multiple marker types

  Hotspot Types:
  1. Product Hotspot - Standard product card popup
  2. Info Hotspot - Hover content circles that display text/info next to the point
  3. Parts/Accessories - Numbered markers for parts diagrams

  @example
  {% section 'shoppable-image-enhanced' %}
{% enddoc %}

{%- style -%}
  #shopify-section-{{ section.id }} {
    --hotspot-size: {{ section.settings.hotspot_size }}px;
    --hotspot-color: {{ section.settings.hotspot_color }};
    --hotspot-pulse-color: {{ section.settings.hotspot_pulse_color }};
    --info-hotspot-color: {{ section.settings.info_hotspot_color }};
    --parts-hotspot-color: {{ section.settings.parts_hotspot_color }};
    --card-bg: {{ section.settings.card_background }};
    --card-width: {{ section.settings.card_width }}px;
  }
{%- endstyle -%}

<section class="shoppable-enhanced section" data-section-id="{{ section.id }}">
  <div class="container">
    {%- if section.settings.title != blank -%}
      <header class="shoppable-enhanced__header">
        {%- if section.settings.subtitle != blank -%}
          <p class="shoppable-enhanced__subtitle">{{ section.settings.subtitle }}</p>
        {%- endif -%}
        <h2 class="shoppable-enhanced__title">{{ section.settings.title }}</h2>
        {%- if section.settings.description != blank -%}
          <p class="shoppable-enhanced__description">{{ section.settings.description }}</p>
        {%- endif -%}
      </header>
    {%- endif -%}

    <div class="shoppable-enhanced__wrapper">
      <div class="shoppable-enhanced__container">
        {%- if section.settings.image != blank -%}
          {% render 'image',
            image: section.settings.image,
            class: 'shoppable-enhanced__image',
            loading: 'lazy'
          %}
        {%- else -%}
          {{ 'lifestyle-1' | placeholder_svg_tag: 'shoppable-enhanced__placeholder' }}
        {%- endif -%}

        {%- comment -%} Render all hotspots {%- endcomment -%}
        {%- assign part_number = 0 -%}
        {%- for block in section.blocks -%}
          {%- case block.type -%}
            {%- comment -%} ========== PRODUCT HOTSPOT ========== {%- endcomment -%}
            {%- when 'product_hotspot' -%}
              {%- assign product = block.settings.product -%}
              <div
                class="hotspot hotspot--product"
                style="top: {{ block.settings.position_y }}%; left: {{ block.settings.position_x }}%;"
                {{ block.shopify_attributes }}
              >
                <button
                  type="button"
                  class="hotspot__trigger"
                  aria-expanded="false"
                  aria-controls="hotspot-card-{{ block.id }}"
                  aria-label="{% if product != blank %}{{ product.title }}{% else %}Product details{% endif %}"
                  data-hotspot-trigger
                >
                  <span class="hotspot__dot"></span>
                  <span class="hotspot__pulse"></span>
                </button>

                <div
                  id="hotspot-card-{{ block.id }}"
                  class="hotspot__card hotspot__card--{{ block.settings.card_position }}"
                  data-hotspot-card
                >
                  {%- if product != blank -%}
                    <a href="{{ product.url }}" class="hotspot__product">
                      {%- if product.featured_image != blank -%}
                        <div class="hotspot__product-image">
                          {% render 'image', image: product.featured_image, width: 200 %}
                        </div>
                      {%- endif -%}
                      <div class="hotspot__product-info">
                        <h4 class="hotspot__product-title">{{ product.title }}</h4>
                        {%- if block.settings.show_vendor and product.vendor != blank -%}
                          <p class="hotspot__product-vendor">{{ product.vendor }}</p>
                        {%- endif -%}
                        <div class="hotspot__product-price">
                          {%- if product.compare_at_price > product.price -%}
                            <span class="hotspot__price hotspot__price--sale">{{ product.price | money }}</span>
                            <span class="hotspot__price hotspot__price--compare">{{ product.compare_at_price | money }}</span>
                          {%- else -%}
                            <span class="hotspot__price">{{ product.price | money }}</span>
                          {%- endif -%}
                        </div>
                      </div>
                    </a>
                    {%- if block.settings.show_quick_add and product.available -%}
                      {%- if product.variants.size == 1 -%}
                        <form action="{{ routes.cart_add_url }}" method="post" class="hotspot__form">
                          <input type="hidden" name="id" value="{{ product.first_available_variant.id }}">
                          <button type="submit" class="btn btn--small hotspot__add-btn">
                            {{ 'products.product.add_to_cart' | t | default: 'Add to Cart' }}
                          </button>
                        </form>
                      {%- else -%}
                        <a href="{{ product.url }}" class="btn btn--outline btn--small hotspot__add-btn">
                          {{ 'products.card.view_product' | t | default: 'View Options' }}
                        </a>
                      {%- endif -%}
                    {%- endif -%}
                  {%- else -%}
                    <div class="hotspot__empty">
                      <p>Select a product</p>
                    </div>
                  {%- endif -%}
                  <button type="button" class="hotspot__close" aria-label="Close" data-hotspot-close>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="18" y1="6" x2="6" y2="18"></line>
                      <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                  </button>
                </div>
              </div>

            {%- comment -%} ========== INFO HOTSPOT (Hover Content) ========== {%- endcomment -%}
            {%- when 'info_hotspot' -%}
              <div
                class="hotspot hotspot--info"
                style="top: {{ block.settings.position_y }}%; left: {{ block.settings.position_x }}%;"
                {{ block.shopify_attributes }}
                data-hotspot-info
              >
                <button
                  type="button"
                  class="hotspot__trigger hotspot__trigger--info"
                  aria-expanded="false"
                  aria-label="{{ block.settings.title }}"
                  data-info-trigger
                >
                  {%- if block.settings.icon == 'info' -%}
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"></circle>
                      <line x1="12" y1="16" x2="12" y2="12"></line>
                      <line x1="12" y1="8" x2="12.01" y2="8"></line>
                    </svg>
                  {%- elsif block.settings.icon == 'help' -%}
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"></circle>
                      <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                      <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                  {%- elsif block.settings.icon == 'star' -%}
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2">
                      <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                    </svg>
                  {%- else -%}
                    <span class="hotspot__dot hotspot__dot--info"></span>
                  {%- endif -%}
                </button>

                <div class="hotspot__info-bubble hotspot__info-bubble--{{ block.settings.bubble_position }}" data-info-bubble>
                  {%- if block.settings.title != blank -%}
                    <h5 class="hotspot__info-title">{{ block.settings.title }}</h5>
                  {%- endif -%}
                  {%- if block.settings.content != blank -%}
                    <p class="hotspot__info-content">{{ block.settings.content }}</p>
                  {%- endif -%}
                  {%- if block.settings.link != blank -%}
                    <a href="{{ block.settings.link }}" class="hotspot__info-link">
                      {{ block.settings.link_text | default: 'Learn more' }}
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                        <polyline points="12 5 19 12 12 19"></polyline>
                      </svg>
                    </a>
                  {%- endif -%}
                </div>
              </div>

            {%- comment -%} ========== PARTS/ACCESSORIES HOTSPOT ========== {%- endcomment -%}
            {%- when 'parts_hotspot' -%}
              {%- assign part_number = part_number | plus: 1 -%}
              {%- assign product = block.settings.product -%}
              <div
                class="hotspot hotspot--parts"
                style="top: {{ block.settings.position_y }}%; left: {{ block.settings.position_x }}%;"
                {{ block.shopify_attributes }}
              >
                <button
                  type="button"
                  class="hotspot__trigger hotspot__trigger--parts"
                  aria-expanded="false"
                  aria-controls="parts-card-{{ block.id }}"
                  aria-label="Part {{ block.settings.part_number | default: part_number }}: {{ block.settings.part_name | default: product.title }}"
                  data-parts-trigger
                >
                  <span class="hotspot__number">{{ block.settings.part_number | default: part_number }}</span>
                </button>

                <div
                  id="parts-card-{{ block.id }}"
                  class="hotspot__parts-card hotspot__parts-card--{{ block.settings.card_position }}"
                  data-parts-card
                >
                  <div class="hotspot__parts-header">
                    <span class="hotspot__parts-number">{{ block.settings.part_number | default: part_number }}</span>
                    <div class="hotspot__parts-title-wrap">
                      <h5 class="hotspot__parts-title">{{ block.settings.part_name | default: 'Part Name' }}</h5>
                      {%- if block.settings.part_sku != blank -%}
                        <span class="hotspot__parts-sku">SKU: {{ block.settings.part_sku }}</span>
                      {%- endif -%}
                    </div>
                  </div>

                  {%- if block.settings.part_description != blank -%}
                    <p class="hotspot__parts-desc">{{ block.settings.part_description }}</p>
                  {%- endif -%}

                  {%- if product != blank -%}
                    <div class="hotspot__parts-product">
                      <div class="hotspot__parts-price">
                        {%- if product.available -%}
                          <span class="hotspot__parts-availability hotspot__parts-availability--in">In Stock</span>
                        {%- else -%}
                          <span class="hotspot__parts-availability hotspot__parts-availability--out">Out of Stock</span>
                        {%- endif -%}
                        <span class="hotspot__parts-price-value">{{ product.price | money }}</span>
                      </div>
                      <a href="{{ product.url }}" class="btn btn--small hotspot__parts-btn">
                        View Part
                      </a>
                    </div>
                  {%- elsif block.settings.link != blank -%}
                    <a href="{{ block.settings.link }}" class="btn btn--small btn--outline hotspot__parts-btn">
                      {{ block.settings.link_text | default: 'View Details' }}
                    </a>
                  {%- endif -%}

                  <button type="button" class="hotspot__close" aria-label="Close" data-hotspot-close>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="18" y1="6" x2="6" y2="18"></line>
                      <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                  </button>
                </div>
              </div>
          {%- endcase -%}
        {%- endfor -%}
      </div>

      {%- comment -%} Parts Legend (if there are parts hotspots) {%- endcomment -%}
      {%- assign has_parts = false -%}
      {%- for block in section.blocks -%}
        {%- if block.type == 'parts_hotspot' -%}
          {%- assign has_parts = true -%}
          {%- break -%}
        {%- endif -%}
      {%- endfor -%}

      {%- if has_parts and section.settings.show_parts_legend -%}
        <aside class="shoppable-enhanced__legend">
          <h3 class="legend__title">{{ section.settings.legend_title | default: 'Parts List' }}</h3>
          <ol class="legend__list">
            {%- assign legend_number = 0 -%}
            {%- for block in section.blocks -%}
              {%- if block.type == 'parts_hotspot' -%}
                {%- assign legend_number = legend_number | plus: 1 -%}
                {%- assign product = block.settings.product -%}
                <li class="legend__item">
                  <span class="legend__number">{{ block.settings.part_number | default: legend_number }}</span>
                  <div class="legend__info">
                    <span class="legend__name">{{ block.settings.part_name | default: 'Part Name' }}</span>
                    {%- if block.settings.part_sku != blank -%}
                      <span class="legend__sku">{{ block.settings.part_sku }}</span>
                    {%- endif -%}
                  </div>
                  {%- if product != blank -%}
                    <span class="legend__price">{{ product.price | money }}</span>
                    <a href="{{ product.url }}" class="legend__link" aria-label="View {{ block.settings.part_name }}">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                        <polyline points="12 5 19 12 12 19"></polyline>
                      </svg>
                    </a>
                  {%- endif -%}
                </li>
              {%- endif -%}
            {%- endfor -%}
          </ol>
        </aside>
      {%- endif -%}

      {%- comment -%} Product List Sidebar {%- endcomment -%}
      {%- if section.settings.show_product_list -%}
        <aside class="shoppable-enhanced__sidebar">
          <h3 class="sidebar__title">{{ section.settings.sidebar_title | default: 'Featured Products' }}</h3>
          <ul class="sidebar__list" role="list">
            {%- for block in section.blocks -%}
              {%- if block.type == 'product_hotspot' -%}
                {%- assign product = block.settings.product -%}
                {%- if product != blank -%}
                  <li class="sidebar__item">
                    <a href="{{ product.url }}" class="sidebar__product">
                      {%- if product.featured_image != blank -%}
                        <div class="sidebar__image">
                          {% render 'image', image: product.featured_image, width: 80 %}
                        </div>
                      {%- endif -%}
                      <div class="sidebar__info">
                        <span class="sidebar__name">{{ product.title }}</span>
                        <span class="sidebar__price">{{ product.price | money }}</span>
                      </div>
                    </a>
                  </li>
                {%- endif -%}
              {%- endif -%}
            {%- endfor -%}
          </ul>
        </aside>
      {%- endif -%}
    </div>
  </div>
</section>

<style>
  /* ============================================
     ENHANCED SHOPPABLE IMAGE STYLES
     ============================================ */
  .shoppable-enhanced__header {
    text-align: center;
    margin-bottom: 40px;
  }

  .shoppable-enhanced__subtitle {
    font-size: 13px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--color-primary);
    margin: 0 0 8px;
  }

  .shoppable-enhanced__title {
    font-size: clamp(1.75rem, 4vw, 2.5rem);
    margin: 0 0 12px;
  }

  .shoppable-enhanced__description {
    max-width: 600px;
    margin: 0 auto;
    color: var(--color-text);
    opacity: 0.8;
  }

  .shoppable-enhanced__wrapper {
    display: grid;
    gap: 32px;
  }

  @media (min-width: 1024px) {
    .shoppable-enhanced__wrapper {
      grid-template-columns: 1fr 280px;
    }
  }

  .shoppable-enhanced__container {
    position: relative;
    border-radius: 12px;
    overflow: hidden;
    background: var(--color-surface);
  }

  .shoppable-enhanced__image {
    display: block;
    width: 100%;
    height: auto;
  }

  .shoppable-enhanced__placeholder {
    width: 100%;
    aspect-ratio: 16 / 10;
    background: var(--color-surface);
  }

  /* ============================================
     BASE HOTSPOT STYLES
     ============================================ */
  .hotspot {
    position: absolute;
    z-index: 10;
    transform: translate(-50%, -50%);
  }

  .hotspot__trigger {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    width: var(--hotspot-size, 32px);
    height: var(--hotspot-size, 32px);
    padding: 0;
    background: none;
    border: none;
    cursor: pointer;
  }

  .hotspot__dot {
    position: absolute;
    inset: 0;
    background: var(--hotspot-color, #334FB4);
    border: 3px solid #fff;
    border-radius: 50%;
    box-shadow: 0 2px 8px rgba(0,0,0,0.25);
    transition: transform 0.2s;
  }

  .hotspot__trigger:hover .hotspot__dot,
  .hotspot__trigger[aria-expanded="true"] .hotspot__dot {
    transform: scale(1.15);
  }

  .hotspot__pulse {
    position: absolute;
    inset: -6px;
    background: var(--hotspot-pulse-color, #334FB4);
    border-radius: 50%;
    opacity: 0;
    animation: hotspot-pulse 2s infinite;
  }

  @keyframes hotspot-pulse {
    0% { transform: scale(0.8); opacity: 0.6; }
    100% { transform: scale(1.8); opacity: 0; }
  }

  .hotspot__trigger:hover .hotspot__pulse {
    animation: none;
    opacity: 0;
  }

  /* ============================================
     PRODUCT HOTSPOT CARD
     ============================================ */
  .hotspot__card {
    position: absolute;
    z-index: 20;
    width: var(--card-width, 260px);
    background: var(--card-bg, #fff);
    border: 1px solid var(--color-border);
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.15);
    opacity: 0;
    visibility: hidden;
    transform: translateY(8px);
    transition: opacity 0.2s, visibility 0.2s, transform 0.2s;
  }

  .hotspot__card.is-open {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .hotspot__card--bottom { top: calc(100% + 14px); left: 50%; transform: translateX(-50%) translateY(8px); }
  .hotspot__card--bottom.is-open { transform: translateX(-50%) translateY(0); }
  .hotspot__card--top { bottom: calc(100% + 14px); left: 50%; transform: translateX(-50%) translateY(-8px); }
  .hotspot__card--top.is-open { transform: translateX(-50%) translateY(0); }
  .hotspot__card--left { right: calc(100% + 14px); top: 50%; transform: translateY(-50%) translateX(-8px); }
  .hotspot__card--left.is-open { transform: translateY(-50%) translateX(0); }
  .hotspot__card--right { left: calc(100% + 14px); top: 50%; transform: translateY(-50%) translateX(8px); }
  .hotspot__card--right.is-open { transform: translateY(-50%) translateX(0); }

  .hotspot__close {
    position: absolute;
    top: 8px;
    right: 8px;
    display: flex;
    padding: 6px;
    background: none;
    border: none;
    color: var(--color-text);
    opacity: 0.5;
    cursor: pointer;
    transition: opacity 0.2s;
  }

  .hotspot__close:hover { opacity: 1; }

  .hotspot__product {
    display: block;
    padding: 16px;
    text-decoration: none;
    color: inherit;
  }

  .hotspot__product-image {
    aspect-ratio: 1;
    overflow: hidden;
    border-radius: 8px;
    margin-bottom: 12px;
    background: var(--color-surface);
  }

  .hotspot__product-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .hotspot__product-info { text-align: center; }

  .hotspot__product-title {
    margin: 0 0 4px;
    font-size: 14px;
    font-weight: 600;
    line-height: 1.3;
  }

  .hotspot__product-vendor {
    margin: 0 0 8px;
    font-size: 12px;
    color: var(--color-text);
    opacity: 0.6;
  }

  .hotspot__product-price {
    display: flex;
    justify-content: center;
    gap: 8px;
    font-size: 14px;
  }

  .hotspot__price--sale { color: var(--color-primary); font-weight: 600; }
  .hotspot__price--compare { text-decoration: line-through; opacity: 0.5; }

  .hotspot__form { padding: 0 16px 16px; }
  .hotspot__add-btn { width: 100%; font-size: 13px; }

  /* ============================================
     INFO HOTSPOT (Hover Bubble)
     ============================================ */
  .hotspot--info .hotspot__trigger--info {
    background: var(--info-hotspot-color, #10b981);
    color: #fff;
    border-radius: 50%;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    transition: transform 0.2s, box-shadow 0.2s;
  }

  .hotspot--info .hotspot__trigger--info:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 16px rgba(0,0,0,0.25);
  }

  .hotspot__dot--info {
    width: 10px;
    height: 10px;
    background: #fff;
    border: none;
    box-shadow: none;
  }

  .hotspot__info-bubble {
    position: absolute;
    z-index: 20;
    width: 220px;
    padding: 14px 16px;
    background: var(--card-bg, #fff);
    border: 1px solid var(--color-border);
    border-radius: 10px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s, visibility 0.2s;
    pointer-events: none;
  }

  .hotspot--info:hover .hotspot__info-bubble,
  .hotspot--info:focus-within .hotspot__info-bubble {
    opacity: 1;
    visibility: visible;
    pointer-events: auto;
  }

  .hotspot__info-bubble--right { left: calc(100% + 12px); top: 50%; transform: translateY(-50%); }
  .hotspot__info-bubble--left { right: calc(100% + 12px); top: 50%; transform: translateY(-50%); }
  .hotspot__info-bubble--top { bottom: calc(100% + 12px); left: 50%; transform: translateX(-50%); }
  .hotspot__info-bubble--bottom { top: calc(100% + 12px); left: 50%; transform: translateX(-50%); }

  .hotspot__info-title {
    margin: 0 0 6px;
    font-size: 14px;
    font-weight: 600;
  }

  .hotspot__info-content {
    margin: 0;
    font-size: 13px;
    line-height: 1.5;
    color: var(--color-text);
    opacity: 0.8;
  }

  .hotspot__info-link {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    margin-top: 10px;
    font-size: 13px;
    font-weight: 600;
    color: var(--color-primary);
    text-decoration: none;
  }

  .hotspot__info-link:hover { text-decoration: underline; }

  /* ============================================
     PARTS/ACCESSORIES HOTSPOT
     ============================================ */
  .hotspot--parts .hotspot__trigger--parts {
    width: 28px;
    height: 28px;
    background: var(--parts-hotspot-color, #f59e0b);
    border: 2px solid #fff;
    border-radius: 50%;
    box-shadow: 0 2px 8px rgba(0,0,0,0.25);
    transition: transform 0.2s;
  }

  .hotspot--parts .hotspot__trigger--parts:hover {
    transform: scale(1.15);
  }

  .hotspot__number {
    font-size: 12px;
    font-weight: 700;
    color: #fff;
    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
  }

  .hotspot__parts-card {
    position: absolute;
    z-index: 20;
    width: 280px;
    background: var(--card-bg, #fff);
    border: 1px solid var(--color-border);
    border-radius: 10px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    opacity: 0;
    visibility: hidden;
    transform: translateY(8px);
    transition: opacity 0.2s, visibility 0.2s, transform 0.2s;
    overflow: hidden;
  }

  .hotspot__parts-card.is-open {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .hotspot__parts-card--bottom { top: calc(100% + 12px); left: 50%; transform: translateX(-50%) translateY(8px); }
  .hotspot__parts-card--bottom.is-open { transform: translateX(-50%) translateY(0); }
  .hotspot__parts-card--top { bottom: calc(100% + 12px); left: 50%; transform: translateX(-50%) translateY(-8px); }
  .hotspot__parts-card--top.is-open { transform: translateX(-50%) translateY(0); }
  .hotspot__parts-card--left { right: calc(100% + 12px); top: 50%; transform: translateY(-50%) translateX(-8px); }
  .hotspot__parts-card--left.is-open { transform: translateY(-50%) translateX(0); }
  .hotspot__parts-card--right { left: calc(100% + 12px); top: 50%; transform: translateY(-50%) translateX(8px); }
  .hotspot__parts-card--right.is-open { transform: translateY(-50%) translateX(0); }

  .hotspot__parts-header {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 14px 16px;
    background: var(--parts-hotspot-color, #f59e0b);
    color: #fff;
  }

  .hotspot__parts-number {
    flex-shrink: 0;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: 700;
    background: rgba(255,255,255,0.25);
    border-radius: 50%;
  }

  .hotspot__parts-title-wrap { flex: 1; min-width: 0; }

  .hotspot__parts-title {
    margin: 0 0 2px;
    font-size: 14px;
    font-weight: 600;
    line-height: 1.3;
  }

  .hotspot__parts-sku {
    font-size: 11px;
    opacity: 0.85;
  }

  .hotspot__parts-desc {
    margin: 0;
    padding: 12px 16px;
    font-size: 13px;
    line-height: 1.5;
    color: var(--color-text);
    border-bottom: 1px solid var(--color-border);
  }

  .hotspot__parts-product {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    padding: 12px 16px;
  }

  .hotspot__parts-price {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .hotspot__parts-availability {
    font-size: 11px;
    font-weight: 600;
  }

  .hotspot__parts-availability--in { color: #16a34a; }
  .hotspot__parts-availability--out { color: #dc2626; }

  .hotspot__parts-price-value {
    font-size: 16px;
    font-weight: 700;
  }

  .hotspot__parts-btn {
    flex-shrink: 0;
  }

  .hotspot__parts-card .hotspot__close {
    top: 10px;
    right: 10px;
    color: #fff;
    opacity: 0.8;
  }

  /* ============================================
     PARTS LEGEND
     ============================================ */
  .shoppable-enhanced__legend {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 12px;
    padding: 20px;
  }

  .legend__title {
    font-size: 16px;
    margin: 0 0 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--color-border);
  }

  .legend__list {
    list-style: none;
    margin: 0;
    padding: 0;
    counter-reset: none;
  }

  .legend__item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 0;
    border-bottom: 1px solid var(--color-border);
  }

  .legend__item:last-child { border-bottom: none; }

  .legend__number {
    flex-shrink: 0;
    width: 26px;
    height: 26px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 700;
    background: var(--parts-hotspot-color, #f59e0b);
    color: #fff;
    border-radius: 50%;
  }

  .legend__info {
    flex: 1;
    min-width: 0;
  }

  .legend__name {
    display: block;
    font-size: 14px;
    font-weight: 500;
    line-height: 1.3;
  }

  .legend__sku {
    display: block;
    font-size: 11px;
    color: var(--color-text);
    opacity: 0.6;
  }

  .legend__price {
    font-size: 14px;
    font-weight: 600;
    color: var(--color-primary);
  }

  .legend__link {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    color: var(--color-text);
    border: 1px solid var(--color-border);
    border-radius: 6px;
    transition: background 0.2s, color 0.2s;
  }

  .legend__link:hover {
    background: var(--color-primary);
    border-color: var(--color-primary);
    color: #fff;
  }

  /* ============================================
     SIDEBAR (Product List)
     ============================================ */
  .shoppable-enhanced__sidebar {
    background: var(--color-surface);
    border-radius: 12px;
    padding: 20px;
  }

  .sidebar__title {
    font-size: 16px;
    margin: 0 0 16px;
  }

  .sidebar__list {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .sidebar__item + .sidebar__item {
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid var(--color-border);
  }

  .sidebar__product {
    display: flex;
    gap: 12px;
    text-decoration: none;
    color: inherit;
  }

  .sidebar__image {
    flex-shrink: 0;
    width: 60px;
    aspect-ratio: 1;
    overflow: hidden;
    border-radius: 6px;
    background: var(--color-background);
  }

  .sidebar__image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .sidebar__info {
    display: flex;
    flex-direction: column;
    justify-content: center;
    min-width: 0;
  }

  .sidebar__name {
    font-size: 14px;
    font-weight: 500;
    line-height: 1.3;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .sidebar__price {
    font-size: 14px;
    color: var(--color-text);
    opacity: 0.7;
  }
</style>

<script>
  (function() {
    const section = document.querySelector('.shoppable-enhanced');
    if (!section) return;

    // Product & Parts hotspots (click to open)
    const clickTriggers = section.querySelectorAll('[data-hotspot-trigger], [data-parts-trigger]');
    let activeCard = null;

    clickTriggers.forEach(trigger => {
      const card = trigger.nextElementSibling;
      const closeBtn = card?.querySelector('[data-hotspot-close]');

      trigger.addEventListener('click', (e) => {
        e.stopPropagation();
        const isOpen = card?.classList.contains('is-open');

        // Close any other open cards
        closeAllCards();

        if (!isOpen && card) {
          card.classList.add('is-open');
          trigger.setAttribute('aria-expanded', 'true');
          activeCard = card;
        }
      });

      closeBtn?.addEventListener('click', (e) => {
        e.stopPropagation();
        card?.classList.remove('is-open');
        trigger.setAttribute('aria-expanded', 'false');
        activeCard = null;
      });

      // Keyboard support
      trigger.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          card?.classList.remove('is-open');
          trigger.setAttribute('aria-expanded', 'false');
          activeCard = null;
        }
      });
    });

    function closeAllCards() {
      clickTriggers.forEach(t => {
        const c = t.nextElementSibling;
        if (c) {
          c.classList.remove('is-open');
          t.setAttribute('aria-expanded', 'false');
        }
      });
      activeCard = null;
    }

    // Close on outside click
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.hotspot') && activeCard) {
        closeAllCards();
      }
    });

    // Close on escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && activeCard) {
        closeAllCards();
      }
    });
  })();
</script>

{% schema %}
{
  "name": "Shoppable Image (Enhanced)",
  "tag": "section",
  "class": "section-shoppable-enhanced",
  "settings": [
    {
      "type": "text",
      "id": "subtitle",
      "label": "Subtitle"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Heading",
      "default": "Shop the Look"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Description"
    },
    {
      "type": "image_picker",
      "id": "image",
      "label": "Image"
    },
    {
      "type": "header",
      "content": "Product Hotspot Styling"
    },
    {
      "type": "range",
      "id": "hotspot_size",
      "label": "Hotspot size",
      "min": 24,
      "max": 48,
      "step": 4,
      "default": 32,
      "unit": "px"
    },
    {
      "type": "color",
      "id": "hotspot_color",
      "label": "Product hotspot color",
      "default": "#334FB4"
    },
    {
      "type": "color",
      "id": "hotspot_pulse_color",
      "label": "Pulse animation color",
      "default": "#334FB4"
    },
    {
      "type": "header",
      "content": "Info Hotspot Styling"
    },
    {
      "type": "color",
      "id": "info_hotspot_color",
      "label": "Info hotspot color",
      "default": "#10b981"
    },
    {
      "type": "header",
      "content": "Parts Hotspot Styling"
    },
    {
      "type": "color",
      "id": "parts_hotspot_color",
      "label": "Parts hotspot color",
      "default": "#f59e0b"
    },
    {
      "type": "checkbox",
      "id": "show_parts_legend",
      "label": "Show parts legend",
      "default": true,
      "info": "Display a sidebar list of all parts"
    },
    {
      "type": "text",
      "id": "legend_title",
      "label": "Legend title",
      "default": "Parts List"
    },
    {
      "type": "header",
      "content": "Product Card"
    },
    {
      "type": "color",
      "id": "card_background",
      "label": "Card background",
      "default": "#ffffff"
    },
    {
      "type": "range",
      "id": "card_width",
      "label": "Card width",
      "min": 200,
      "max": 320,
      "step": 20,
      "default": 260,
      "unit": "px"
    },
    {
      "type": "header",
      "content": "Product Sidebar"
    },
    {
      "type": "checkbox",
      "id": "show_product_list",
      "label": "Show product list sidebar",
      "default": false
    },
    {
      "type": "text",
      "id": "sidebar_title",
      "label": "Sidebar title",
      "default": "Featured Products"
    }
  ],
  "blocks": [
    {
      "type": "product_hotspot",
      "name": "Product Hotspot",
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Product"
        },
        {
          "type": "range",
          "id": "position_x",
          "label": "Horizontal position",
          "min": 0,
          "max": 100,
          "step": 1,
          "default": 50,
          "unit": "%"
        },
        {
          "type": "range",
          "id": "position_y",
          "label": "Vertical position",
          "min": 0,
          "max": 100,
          "step": 1,
          "default": 50,
          "unit": "%"
        },
        {
          "type": "select",
          "id": "card_position",
          "label": "Card position",
          "options": [
            { "value": "bottom", "label": "Below" },
            { "value": "top", "label": "Above" },
            { "value": "left", "label": "Left" },
            { "value": "right", "label": "Right" }
          ],
          "default": "bottom"
        },
        {
          "type": "checkbox",
          "id": "show_vendor",
          "label": "Show vendor",
          "default": false
        },
        {
          "type": "checkbox",
          "id": "show_quick_add",
          "label": "Show add to cart button",
          "default": true
        }
      ]
    },
    {
      "type": "info_hotspot",
      "name": "Info Hotspot",
      "settings": [
        {
          "type": "range",
          "id": "position_x",
          "label": "Horizontal position",
          "min": 0,
          "max": 100,
          "step": 1,
          "default": 50,
          "unit": "%"
        },
        {
          "type": "range",
          "id": "position_y",
          "label": "Vertical position",
          "min": 0,
          "max": 100,
          "step": 1,
          "default": 50,
          "unit": "%"
        },
        {
          "type": "select",
          "id": "icon",
          "label": "Icon",
          "options": [
            { "value": "dot", "label": "Dot" },
            { "value": "info", "label": "Info (i)" },
            { "value": "help", "label": "Help (?)" },
            { "value": "star", "label": "Star" }
          ],
          "default": "info"
        },
        {
          "type": "text",
          "id": "title",
          "label": "Title",
          "default": "Feature Highlight"
        },
        {
          "type": "textarea",
          "id": "content",
          "label": "Content",
          "default": "Describe this feature or area of the image."
        },
        {
          "type": "url",
          "id": "link",
          "label": "Link (optional)"
        },
        {
          "type": "text",
          "id": "link_text",
          "label": "Link text",
          "default": "Learn more"
        },
        {
          "type": "select",
          "id": "bubble_position",
          "label": "Bubble position",
          "options": [
            { "value": "right", "label": "Right" },
            { "value": "left", "label": "Left" },
            { "value": "top", "label": "Above" },
            { "value": "bottom", "label": "Below" }
          ],
          "default": "right"
        }
      ]
    },
    {
      "type": "parts_hotspot",
      "name": "Parts/Accessories",
      "settings": [
        {
          "type": "range",
          "id": "position_x",
          "label": "Horizontal position",
          "min": 0,
          "max": 100,
          "step": 1,
          "default": 50,
          "unit": "%"
        },
        {
          "type": "range",
          "id": "position_y",
          "label": "Vertical position",
          "min": 0,
          "max": 100,
          "step": 1,
          "default": 50,
          "unit": "%"
        },
        {
          "type": "text",
          "id": "part_number",
          "label": "Part number (display)",
          "info": "Leave blank to auto-number"
        },
        {
          "type": "text",
          "id": "part_name",
          "label": "Part name",
          "default": "Component Name"
        },
        {
          "type": "text",
          "id": "part_sku",
          "label": "Part SKU"
        },
        {
          "type": "textarea",
          "id": "part_description",
          "label": "Part description"
        },
        {
          "type": "product",
          "id": "product",
          "label": "Linked product (optional)"
        },
        {
          "type": "url",
          "id": "link",
          "label": "Custom link (if no product)"
        },
        {
          "type": "text",
          "id": "link_text",
          "label": "Link text",
          "default": "View Details"
        },
        {
          "type": "select",
          "id": "card_position",
          "label": "Card position",
          "options": [
            { "value": "bottom", "label": "Below" },
            { "value": "top", "label": "Above" },
            { "value": "left", "label": "Left" },
            { "value": "right", "label": "Right" }
          ],
          "default": "right"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Shoppable Image (Enhanced)",
      "blocks": [
        { "type": "product_hotspot", "settings": { "position_x": 25, "position_y": 40 } },
        { "type": "info_hotspot", "settings": { "position_x": 50, "position_y": 30, "title": "Key Feature", "content": "This area highlights an important feature." } },
        { "type": "parts_hotspot", "settings": { "position_x": 75, "position_y": 60, "part_name": "Main Assembly" } }
      ]
    }
  ]
}
{% endschema %}
