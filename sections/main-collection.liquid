<section class="main-collection section" id="CollectionSection">
  <div class="container">
    <header class="collection-header">
      <h1 class="collection-header__title">{{ collection.title }}</h1>
      {%- if collection.description != blank -%}
        <div class="collection-header__description">
          {{ collection.description }}
        </div>
      {%- endif -%}
    </header>

    {%- liquid
      assign filter_position = settings.collection_filter_position | default: 'left'
      assign is_horizontal = false
      if filter_position == 'horizontal'
        assign is_horizontal = true
      endif
    -%}

    {%- if collection.products.size > 0 -%}
      {%- comment -%} Horizontal Filters (above products) {%- endcomment -%}
      {%- if is_horizontal and section.settings.enable_filtering -%}
        <div class="collection-filters-horizontal">
          {% render 'product-filters', collection: collection %}
        </div>
      {%- endif -%}

      <div class="collection-layout{% if filter_position == 'right' %} collection-layout--reverse{% endif %}{% if is_horizontal %} collection-layout--no-sidebar{% endif %}">
        {%- comment -%} Sidebar Filters (left or right) {%- endcomment -%}
        {%- if section.settings.enable_filtering or section.settings.enable_sorting -%}
          {%- unless is_horizontal -%}
            <div class="collection-sidebar{% if filter_position == 'right' %} collection-sidebar--right{% endif %}" id="CollectionFilters">
              {% render 'product-filters', collection: collection %}

              {%- comment -%} Custom content blocks below filters {%- endcomment -%}
              {%- for block in section.blocks -%}
                {%- case block.type -%}
                  {%- when 'filter_content' -%}
                    <div class="filter-content-block" {{ block.shopify_attributes }}>
                      {%- if block.settings.heading != blank -%}
                        <h3 class="filter-content-block__heading">{{ block.settings.heading }}</h3>
                      {%- endif -%}
                      {%- if block.settings.content != blank -%}
                        <div class="filter-content-block__content">{{ block.settings.content }}</div>
                      {%- endif -%}
                      {%- if block.settings.button_label != blank -%}
                        <a href="{{ block.settings.button_link }}" class="filter-content-block__button btn btn--outline">
                          {{ block.settings.button_label }}
                        </a>
                      {%- endif -%}
                    </div>

                  {%- when 'filter_image' -%}
                    <div class="filter-image-block" {{ block.shopify_attributes }}>
                      {%- if block.settings.image != blank -%}
                        <a href="{{ block.settings.link | default: '#' }}" class="filter-image-block__link">
                          {{ block.settings.image | image_url: width: 400 | image_tag: loading: 'lazy', class: 'filter-image-block__image' }}
                          {%- if block.settings.overlay_text != blank -%}
                            <span class="filter-image-block__overlay">{{ block.settings.overlay_text }}</span>
                          {%- endif -%}
                        </a>
                      {%- endif -%}
                    </div>

                  {%- when 'filter_links' -%}
                    <div class="filter-links-block" {{ block.shopify_attributes }}>
                      {%- if block.settings.heading != blank -%}
                        <h3 class="filter-links-block__heading">{{ block.settings.heading }}</h3>
                      {%- endif -%}
                      <ul class="filter-links-block__list">
                        {%- if block.settings.link_1_label != blank -%}
                          <li><a href="{{ block.settings.link_1_url }}">{{ block.settings.link_1_label }}</a></li>
                        {%- endif -%}
                        {%- if block.settings.link_2_label != blank -%}
                          <li><a href="{{ block.settings.link_2_url }}">{{ block.settings.link_2_label }}</a></li>
                        {%- endif -%}
                        {%- if block.settings.link_3_label != blank -%}
                          <li><a href="{{ block.settings.link_3_url }}">{{ block.settings.link_3_label }}</a></li>
                        {%- endif -%}
                        {%- if block.settings.link_4_label != blank -%}
                          <li><a href="{{ block.settings.link_4_url }}">{{ block.settings.link_4_label }}</a></li>
                        {%- endif -%}
                      </ul>
                    </div>
                {%- endcase -%}
              {%- endfor -%}
            </div>
          {%- endunless -%}
        {%- endif -%}

        <div class="collection-main">
          {%- comment -%} Mobile Filter Toggle {%- endcomment -%}
          {%- unless is_horizontal -%}
            <button type="button" class="collection-filter-toggle" data-filter-toggle aria-controls="CollectionFilters">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="4" y1="21" x2="4" y2="14"></line>
                <line x1="4" y1="10" x2="4" y2="3"></line>
                <line x1="12" y1="21" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12" y2="3"></line>
                <line x1="20" y1="21" x2="20" y2="16"></line>
                <line x1="20" y1="12" x2="20" y2="3"></line>
                <line x1="1" y1="14" x2="7" y2="14"></line>
                <line x1="9" y1="8" x2="15" y2="8"></line>
                <line x1="17" y1="16" x2="23" y2="16"></line>
              </svg>
              {{ 'collections.filters.title' | t | default: 'Filters' }}
              {%- assign active_count = 0 -%}
              {%- for filter in collection.filters -%}
                {%- assign active_count = active_count | plus: filter.active_values.size -%}
              {%- endfor -%}
              {%- if active_count > 0 -%}
                <span class="collection-filter-toggle__count">{{ active_count }}</span>
              {%- endif -%}
            </button>
          {%- endunless -%}

          <div class="collection-toolbar">
            <p class="collection-toolbar__count">
              {{ 'collections.products_count' | t: count: collection.products_count }}
            </p>

            {%- if section.settings.enable_sorting -%}
              <div class="collection-toolbar__view">
                <button
                  type="button"
                  class="collection-toolbar__view-btn{% if section.settings.default_view == 'grid' %} is-active{% endif %}"
                  data-view-toggle="grid"
                  aria-label="Grid view"
                >
                  <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                    <rect x="1" y="1" width="7" height="7" rx="1"/>
                    <rect x="12" y="1" width="7" height="7" rx="1"/>
                    <rect x="1" y="12" width="7" height="7" rx="1"/>
                    <rect x="12" y="12" width="7" height="7" rx="1"/>
                  </svg>
                </button>
                <button
                  type="button"
                  class="collection-toolbar__view-btn{% if section.settings.default_view == 'list' %} is-active{% endif %}"
                  data-view-toggle="list"
                  aria-label="List view"
                >
                  <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                    <rect x="1" y="2" width="18" height="3" rx="1"/>
                    <rect x="1" y="8.5" width="18" height="3" rx="1"/>
                    <rect x="1" y="15" width="18" height="3" rx="1"/>
                  </svg>
                </button>
              </div>
            {%- endif -%}
          </div>

          {%- paginate collection.products by section.settings.products_per_page -%}
            <div
              id="ProductGrid"
              class="collection-grid collection-grid--{{ section.settings.default_view }}"
              style="--columns: {{ section.settings.columns }};"
              data-product-grid
            >
              {%- for product in collection.products -%}
                <div class="collection-grid__item">
                  {% render 'product-card', product: product %}
                </div>
              {%- endfor -%}
            </div>

            {%- if paginate.pages > 1 -%}
              <nav class="pagination" aria-label="{{ 'general.pagination.page' | t }}">
                {%- if paginate.previous -%}
                  <a href="{{ paginate.previous.url }}" class="pagination__link pagination__link--prev">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                    {{ 'general.pagination.previous' | t }}
                  </a>
                {%- endif -%}

                <div class="pagination__pages">
                  {%- for part in paginate.parts -%}
                    {%- if part.is_link -%}
                      <a href="{{ part.url }}" class="pagination__page">{{ part.title }}</a>
                    {%- else -%}
                      {%- if part.title == paginate.current_page -%}
                        <span class="pagination__page pagination__page--current" aria-current="page">
                          {{ part.title }}
                        </span>
                      {%- else -%}
                        <span class="pagination__page pagination__page--ellipsis">{{ part.title }}</span>
                      {%- endif -%}
                    {%- endif -%}
                  {%- endfor -%}
                </div>

                {%- if paginate.next -%}
                  <a href="{{ paginate.next.url }}" class="pagination__link pagination__link--next">
                    {{ 'general.pagination.next' | t }}
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                  </a>
                {%- endif -%}
              </nav>
            {%- endif -%}
          {%- endpaginate -%}
        </div>
      </div>
    {%- else -%}
      <p class="collection-empty">{{ 'collections.empty' | t }}</p>
    {%- endif -%}
  </div>
</section>

<script src="{{ 'product-filters.js' | asset_url }}" defer></script>

{% stylesheet %}
  .collection-header {
    margin-block-end: var(--space-8);
  }

  .collection-header__title {
    margin-block-end: var(--space-4);
    font-size: var(--font-size-3xl);
  }

  .collection-header__description {
    max-width: 65ch;
    color: var(--color-text-secondary);
  }

  /* Mobile filter toggle */
  .collection-filter-toggle {
    display: none;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-3) var(--space-4);
    background: var(--color-background-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-button);
    font-size: var(--font-size-sm);
    font-weight: 500;
    cursor: pointer;
    margin-bottom: var(--space-4);
  }

  .collection-filter-toggle__count {
    background: var(--color-primary);
    color: var(--color-button-text);
    font-size: var(--font-size-xs);
    padding: 0.125rem 0.5rem;
    border-radius: var(--radius-full);
  }

  @media (max-width: 63.9375rem) {
    .collection-filter-toggle {
      display: inline-flex;
    }
  }

  /* Horizontal filters container */
  .collection-filters-horizontal {
    margin-bottom: var(--space-6);
  }

  .collection-layout {
    display: grid;
    gap: var(--space-8);
  }

  .collection-layout--no-sidebar {
    display: block;
  }

  @media (min-width: 64rem) {
    .collection-layout {
      grid-template-columns: 16rem 1fr;
      gap: var(--space-10);
    }

    .collection-layout--reverse {
      grid-template-columns: 1fr 16rem;
    }

    .collection-layout--reverse .collection-sidebar {
      order: 2;
    }

    .collection-layout--reverse .collection-main {
      order: 1;
    }
  }

  .collection-sidebar {
    position: sticky;
    top: calc(4rem + var(--space-4));
    align-self: start;
    max-height: calc(100vh - 6rem);
    overflow-y: auto;
  }

  /* Filter content blocks */
  .filter-content-block,
  .filter-image-block,
  .filter-links-block {
    margin-top: var(--space-6);
    padding-top: var(--space-6);
    border-top: 1px solid var(--color-border);
  }

  .filter-content-block__heading,
  .filter-links-block__heading {
    font-size: var(--font-size-sm);
    font-weight: 600;
    margin: 0 0 var(--space-3);
  }

  .filter-content-block__content {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    line-height: 1.6;
    margin-bottom: var(--space-4);
  }

  .filter-content-block__button {
    width: 100%;
    font-size: var(--font-size-xs);
  }

  .filter-image-block__link {
    display: block;
    position: relative;
    border-radius: var(--radius-md);
    overflow: hidden;
  }

  .filter-image-block__image {
    width: 100%;
    height: auto;
    transition: transform var(--duration-normal) var(--ease-default);
  }

  .filter-image-block__link:hover .filter-image-block__image {
    transform: scale(1.05);
  }

  .filter-image-block__overlay {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.4);
    color: #fff;
    font-size: var(--font-size-sm);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .filter-links-block__list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .filter-links-block__list li {
    padding: var(--space-2) 0;
    border-bottom: 1px solid var(--color-border);
  }

  .filter-links-block__list li:last-child {
    border-bottom: none;
  }

  .filter-links-block__list a {
    font-size: var(--font-size-sm);
    color: var(--color-text);
    text-decoration: none;
    transition: color var(--duration-fast) var(--ease-default);
  }

  .filter-links-block__list a:hover {
    color: var(--color-primary);
  }

  .collection-toolbar {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-4);
    margin-block-end: var(--space-6);
  }

  .collection-toolbar__count {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    margin: 0;
  }

  .collection-toolbar__view {
    display: flex;
    gap: var(--space-1);
  }

  .collection-toolbar__view-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-2);
    color: var(--color-text-secondary);
    background: none;
    border: 1px solid transparent;
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition:
      color var(--duration-fast) var(--ease-default),
      border-color var(--duration-fast) var(--ease-default);
  }

  .collection-toolbar__view-btn:hover,
  .collection-toolbar__view-btn.is-active {
    color: var(--color-text);
    border-color: var(--color-border);
  }

  .collection-grid {
    display: grid;
    gap: var(--grid-gap);
  }

  .collection-grid--grid {
    grid-template-columns: repeat(2, 1fr);
  }

  @media (min-width: 48rem) {
    .collection-grid--grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  @media (min-width: 64rem) {
    .collection-grid--grid {
      grid-template-columns: repeat(var(--columns), 1fr);
    }
  }

  .collection-grid--list {
    grid-template-columns: 1fr;
  }

  .collection-grid--list .collection-grid__item {
    display: grid;
    grid-template-columns: 8rem 1fr;
    gap: var(--space-4);
  }

  @media (min-width: 48rem) {
    .collection-grid--list .collection-grid__item {
      grid-template-columns: 12rem 1fr;
    }
  }

  .collection-empty {
    text-align: center;
    padding: var(--space-16) 0;
    color: var(--color-text-secondary);
  }

  /* Pagination */
  .pagination {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-4);
    margin-block-start: var(--space-12);
    flex-wrap: wrap;
  }

  .pagination__link {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-4);
    font-size: var(--font-size-sm);
    font-weight: 500;
    color: var(--color-text);
    text-decoration: none;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-button);
    transition:
      border-color var(--duration-fast) var(--ease-default),
      background-color var(--duration-fast) var(--ease-default);
  }

  .pagination__link:hover {
    border-color: var(--color-text);
    background-color: var(--color-background-secondary);
  }

  .pagination__pages {
    display: flex;
    align-items: center;
    gap: var(--space-1);
  }

  .pagination__page {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 2.5rem;
    height: 2.5rem;
    font-size: var(--font-size-sm);
    text-decoration: none;
    color: var(--color-text);
    border-radius: var(--radius-button);
    transition: background-color var(--duration-fast) var(--ease-default);
  }

  .pagination__page:hover {
    background-color: var(--color-background-secondary);
  }

  .pagination__page--current {
    font-weight: 600;
    background-color: var(--color-text);
    color: var(--color-background);
  }

  .pagination__page--current:hover {
    background-color: var(--color-text);
  }

  .pagination__page--ellipsis {
    color: var(--color-text-secondary);
  }

  /* View toggle animation */
  .collection-grid {
    transition: opacity var(--duration-fast) var(--ease-default);
  }

  .collection-grid.is-changing {
    opacity: 0.5;
  }

  /* Mobile sidebar overlay */
  .collection-sidebar-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: calc(var(--z-modal) - 1);
    opacity: 0;
    visibility: hidden;
    transition: opacity var(--duration-normal) var(--ease-default), visibility var(--duration-normal) var(--ease-default);
  }

  .collection-sidebar-overlay.is-visible {
    opacity: 1;
    visibility: visible;
  }
{% endstylesheet %}

{% javascript %}
  // View toggle functionality
  const viewToggles = document.querySelectorAll('[data-view-toggle]');
  const productGrid = document.querySelector('[data-product-grid]');

  viewToggles.forEach(toggle => {
    toggle.addEventListener('click', () => {
      const view = toggle.dataset.viewToggle;

      // Update active state
      viewToggles.forEach(t => t.classList.remove('is-active'));
      toggle.classList.add('is-active');

      // Animate grid change
      productGrid.classList.add('is-changing');

      setTimeout(() => {
        productGrid.classList.remove('collection-grid--grid', 'collection-grid--list');
        productGrid.classList.add(`collection-grid--${view}`);
        productGrid.classList.remove('is-changing');
      }, 150);

      // Save preference
      localStorage.setItem('collection-view', view);
    });
  });

  // Restore saved view preference
  const savedView = localStorage.getItem('collection-view');
  if (savedView && productGrid) {
    productGrid.classList.remove('collection-grid--grid', 'collection-grid--list');
    productGrid.classList.add(`collection-grid--${savedView}`);

    viewToggles.forEach(t => {
      t.classList.toggle('is-active', t.dataset.viewToggle === savedView);
    });
  }

  // Mobile filter toggle
  const filterToggle = document.querySelector('[data-filter-toggle]');
  const filterSidebar = document.getElementById('CollectionFilters');

  if (filterToggle && filterSidebar) {
    // Create overlay
    const overlay = document.createElement('div');
    overlay.className = 'collection-sidebar-overlay';
    document.body.appendChild(overlay);

    filterToggle.addEventListener('click', () => {
      filterSidebar.classList.toggle('is-open');
      overlay.classList.toggle('is-visible');
      document.body.style.overflow = filterSidebar.classList.contains('is-open') ? 'hidden' : '';
    });

    overlay.addEventListener('click', () => {
      filterSidebar.classList.remove('is-open');
      overlay.classList.remove('is-visible');
      document.body.style.overflow = '';
    });
  }
{% endjavascript %}

{% schema %}
{
  "name": "Collection",
  "settings": [
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "range",
      "id": "products_per_page",
      "label": "Products per page",
      "min": 8,
      "max": 48,
      "step": 4,
      "default": 16
    },
    {
      "type": "range",
      "id": "columns",
      "label": "Columns on desktop",
      "min": 2,
      "max": 5,
      "step": 1,
      "default": 3
    },
    {
      "type": "select",
      "id": "default_view",
      "label": "Default view",
      "options": [
        { "value": "grid", "label": "Grid" },
        { "value": "list", "label": "List" }
      ],
      "default": "grid"
    },
    {
      "type": "header",
      "content": "Filtering and sorting"
    },
    {
      "type": "checkbox",
      "id": "enable_filtering",
      "label": "Enable filtering",
      "default": true,
      "info": "Allow customers to filter products by availability, price, and more. [Customize filters](/admin/menus)"
    },
    {
      "type": "checkbox",
      "id": "enable_sorting",
      "label": "Enable sorting",
      "default": true
    },
    {
      "type": "paragraph",
      "content": "Filter position, default state, and mobile display can be configured in Theme Settings > Collection Filters."
    }
  ],
  "blocks": [
    {
      "type": "filter_content",
      "name": "Content block",
      "settings": [
        {
          "type": "text",
          "id": "heading",
          "label": "Heading",
          "default": "Need Help?"
        },
        {
          "type": "richtext",
          "id": "content",
          "label": "Content",
          "default": "<p>Contact our team for assistance with product selection.</p>"
        },
        {
          "type": "text",
          "id": "button_label",
          "label": "Button label",
          "default": "Contact Us"
        },
        {
          "type": "url",
          "id": "button_link",
          "label": "Button link"
        }
      ]
    },
    {
      "type": "filter_image",
      "name": "Image block",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        },
        {
          "type": "text",
          "id": "overlay_text",
          "label": "Overlay text"
        },
        {
          "type": "url",
          "id": "link",
          "label": "Link"
        }
      ]
    },
    {
      "type": "filter_links",
      "name": "Links block",
      "settings": [
        {
          "type": "text",
          "id": "heading",
          "label": "Heading",
          "default": "Quick Links"
        },
        {
          "type": "text",
          "id": "link_1_label",
          "label": "Link 1 label"
        },
        {
          "type": "url",
          "id": "link_1_url",
          "label": "Link 1 URL"
        },
        {
          "type": "text",
          "id": "link_2_label",
          "label": "Link 2 label"
        },
        {
          "type": "url",
          "id": "link_2_url",
          "label": "Link 2 URL"
        },
        {
          "type": "text",
          "id": "link_3_label",
          "label": "Link 3 label"
        },
        {
          "type": "url",
          "id": "link_3_url",
          "label": "Link 3 URL"
        },
        {
          "type": "text",
          "id": "link_4_label",
          "label": "Link 4 label"
        },
        {
          "type": "url",
          "id": "link_4_url",
          "label": "Link 4 URL"
        }
      ]
    }
  ]
}
{% endschema %}
