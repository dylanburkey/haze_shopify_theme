<section class="main-collection section" id="CollectionSection">
  <div class="container">
    <header class="collection-header">
      <h1 class="collection-header__title">{{ collection.title }}</h1>
      {%- if collection.description != blank -%}
        <div class="collection-header__description">
          {{ collection.description }}
        </div>
      {%- endif -%}
    </header>

    {%- if collection.products.size > 0 -%}
      <div class="collection-layout">
        {%- if section.settings.enable_filtering or section.settings.enable_sorting -%}
          <div class="collection-sidebar" id="CollectionFilters">
            {% render 'product-filters', collection: collection %}
          </div>
        {%- endif -%}

        <div class="collection-main">
          <div class="collection-toolbar">
            <p class="collection-toolbar__count">
              {{ 'collections.products_count' | t: count: collection.products_count }}
            </p>

            {%- if section.settings.enable_sorting -%}
              <div class="collection-toolbar__view">
                <button
                  type="button"
                  class="collection-toolbar__view-btn{% if section.settings.default_view == 'grid' %} is-active{% endif %}"
                  data-view-toggle="grid"
                  aria-label="Grid view"
                >
                  <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                    <rect x="1" y="1" width="7" height="7" rx="1"/>
                    <rect x="12" y="1" width="7" height="7" rx="1"/>
                    <rect x="1" y="12" width="7" height="7" rx="1"/>
                    <rect x="12" y="12" width="7" height="7" rx="1"/>
                  </svg>
                </button>
                <button
                  type="button"
                  class="collection-toolbar__view-btn{% if section.settings.default_view == 'list' %} is-active{% endif %}"
                  data-view-toggle="list"
                  aria-label="List view"
                >
                  <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                    <rect x="1" y="2" width="18" height="3" rx="1"/>
                    <rect x="1" y="8.5" width="18" height="3" rx="1"/>
                    <rect x="1" y="15" width="18" height="3" rx="1"/>
                  </svg>
                </button>
              </div>
            {%- endif -%}
          </div>

          {%- paginate collection.products by section.settings.products_per_page -%}
            <div
              id="ProductGrid"
              class="collection-grid collection-grid--{{ section.settings.default_view }}"
              style="--columns: {{ section.settings.columns }};"
              data-product-grid
            >
              {%- for product in collection.products -%}
                <div class="collection-grid__item">
                  {% render 'product-card', product: product %}
                </div>
              {%- endfor -%}
            </div>

            {%- if paginate.pages > 1 -%}
              <nav class="pagination" aria-label="{{ 'general.pagination.page' | t }}">
                {%- if paginate.previous -%}
                  <a href="{{ paginate.previous.url }}" class="pagination__link pagination__link--prev">
                    {% render 'icon', name: 'chevron-left', size: 16 %}
                    {{ 'general.pagination.previous' | t }}
                  </a>
                {%- endif -%}

                <div class="pagination__pages">
                  {%- for part in paginate.parts -%}
                    {%- if part.is_link -%}
                      <a href="{{ part.url }}" class="pagination__page">{{ part.title }}</a>
                    {%- else -%}
                      {%- if part.title == paginate.current_page -%}
                        <span class="pagination__page pagination__page--current" aria-current="page">
                          {{ part.title }}
                        </span>
                      {%- else -%}
                        <span class="pagination__page pagination__page--ellipsis">{{ part.title }}</span>
                      {%- endif -%}
                    {%- endif -%}
                  {%- endfor -%}
                </div>

                {%- if paginate.next -%}
                  <a href="{{ paginate.next.url }}" class="pagination__link pagination__link--next">
                    {{ 'general.pagination.next' | t }}
                    {% render 'icon', name: 'chevron-right', size: 16 %}
                  </a>
                {%- endif -%}
              </nav>
            {%- endif -%}
          {%- endpaginate -%}
        </div>
      </div>
    {%- else -%}
      <p class="collection-empty">{{ 'collections.empty' | t }}</p>
    {%- endif -%}
  </div>
</section>

<script src="{{ 'product-filters.js' | asset_url }}" defer></script>

{% stylesheet %}
  .collection-header {
    margin-block-end: var(--space-8);
  }

  .collection-header__title {
    margin-block-end: var(--space-4);
    font-size: var(--font-size-3xl);
  }

  .collection-header__description {
    max-width: 65ch;
    color: var(--color-text-secondary);
  }

  .collection-layout {
    display: grid;
    gap: var(--space-8);
  }

  @media (min-width: 64rem) {
    .collection-layout {
      grid-template-columns: 16rem 1fr;
      gap: var(--space-10);
    }
  }

  .collection-sidebar {
    position: sticky;
    top: calc(4rem + var(--space-4));
    align-self: start;
    max-height: calc(100vh - 6rem);
    overflow-y: auto;
  }

  .collection-toolbar {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-4);
    margin-block-end: var(--space-6);
  }

  .collection-toolbar__count {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    margin: 0;
  }

  .collection-toolbar__view {
    display: flex;
    gap: var(--space-1);
  }

  .collection-toolbar__view-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-2);
    color: var(--color-text-secondary);
    background: none;
    border: 1px solid transparent;
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition:
      color var(--duration-fast) var(--ease-default),
      border-color var(--duration-fast) var(--ease-default);
  }

  .collection-toolbar__view-btn:hover,
  .collection-toolbar__view-btn.is-active {
    color: var(--color-text);
    border-color: var(--color-border);
  }

  .collection-grid {
    display: grid;
    gap: var(--grid-gap);
  }

  .collection-grid--grid {
    grid-template-columns: repeat(2, 1fr);
  }

  @media (min-width: 48rem) {
    .collection-grid--grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  @media (min-width: 64rem) {
    .collection-grid--grid {
      grid-template-columns: repeat(var(--columns), 1fr);
    }
  }

  .collection-grid--list {
    grid-template-columns: 1fr;
  }

  .collection-grid--list .collection-grid__item {
    display: grid;
    grid-template-columns: 8rem 1fr;
    gap: var(--space-4);
  }

  @media (min-width: 48rem) {
    .collection-grid--list .collection-grid__item {
      grid-template-columns: 12rem 1fr;
    }
  }

  .collection-empty {
    text-align: center;
    padding: var(--space-16) 0;
    color: var(--color-text-secondary);
  }

  /* Pagination */
  .pagination {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-4);
    margin-block-start: var(--space-12);
    flex-wrap: wrap;
  }

  .pagination__link {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-4);
    font-size: var(--font-size-sm);
    font-weight: 500;
    color: var(--color-text);
    text-decoration: none;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-button);
    transition:
      border-color var(--duration-fast) var(--ease-default),
      background-color var(--duration-fast) var(--ease-default);
  }

  .pagination__link:hover {
    border-color: var(--color-text);
    background-color: var(--color-background-secondary);
  }

  .pagination__pages {
    display: flex;
    align-items: center;
    gap: var(--space-1);
  }

  .pagination__page {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 2.5rem;
    height: 2.5rem;
    font-size: var(--font-size-sm);
    text-decoration: none;
    color: var(--color-text);
    border-radius: var(--radius-button);
    transition: background-color var(--duration-fast) var(--ease-default);
  }

  .pagination__page:hover {
    background-color: var(--color-background-secondary);
  }

  .pagination__page--current {
    font-weight: 600;
    background-color: var(--color-text);
    color: var(--color-background);
  }

  .pagination__page--current:hover {
    background-color: var(--color-text);
  }

  .pagination__page--ellipsis {
    color: var(--color-text-secondary);
  }

  /* View toggle animation */
  .collection-grid {
    transition: opacity var(--duration-fast) var(--ease-default);
  }

  .collection-grid.is-changing {
    opacity: 0.5;
  }
{% endstylesheet %}

{% javascript %}
  // View toggle functionality
  const viewToggles = document.querySelectorAll('[data-view-toggle]');
  const productGrid = document.querySelector('[data-product-grid]');

  viewToggles.forEach(toggle => {
    toggle.addEventListener('click', () => {
      const view = toggle.dataset.viewToggle;

      // Update active state
      viewToggles.forEach(t => t.classList.remove('is-active'));
      toggle.classList.add('is-active');

      // Animate grid change
      productGrid.classList.add('is-changing');

      setTimeout(() => {
        productGrid.classList.remove('collection-grid--grid', 'collection-grid--list');
        productGrid.classList.add(`collection-grid--${view}`);
        productGrid.classList.remove('is-changing');
      }, 150);

      // Save preference
      localStorage.setItem('collection-view', view);
    });
  });

  // Restore saved view preference
  const savedView = localStorage.getItem('collection-view');
  if (savedView && productGrid) {
    productGrid.classList.remove('collection-grid--grid', 'collection-grid--list');
    productGrid.classList.add(`collection-grid--${savedView}`);

    viewToggles.forEach(t => {
      t.classList.toggle('is-active', t.dataset.viewToggle === savedView);
    });
  }
{% endjavascript %}

{% schema %}
{
  "name": "Collection",
  "settings": [
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "range",
      "id": "products_per_page",
      "label": "Products per page",
      "min": 8,
      "max": 48,
      "step": 4,
      "default": 16
    },
    {
      "type": "range",
      "id": "columns",
      "label": "Columns on desktop",
      "min": 2,
      "max": 5,
      "step": 1,
      "default": 3
    },
    {
      "type": "select",
      "id": "default_view",
      "label": "Default view",
      "options": [
        { "value": "grid", "label": "Grid" },
        { "value": "list", "label": "List" }
      ],
      "default": "grid"
    },
    {
      "type": "header",
      "content": "Filtering and sorting"
    },
    {
      "type": "checkbox",
      "id": "enable_filtering",
      "label": "Enable filtering",
      "default": true,
      "info": "Allow customers to filter products by availability, price, and more. [Customize filters](/admin/menus)"
    },
    {
      "type": "checkbox",
      "id": "enable_sorting",
      "label": "Enable sorting",
      "default": true
    }
  ]
}
{% endschema %}
