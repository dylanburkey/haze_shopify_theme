{%- comment -%}
  AutoRAG AI Search Section
  Semantic AI-powered product search using Cloudflare Workers
  Falls back to native Shopify search if no worker URL is configured
{%- endcomment -%}

{{ 'section-autorag.css' | asset_url | stylesheet_tag }}

<div class="autorag-section">
  <div class="page-width">
    {%- if section.settings.heading != blank -%}
      <h2 class="autorag-heading">{{ section.settings.heading }}</h2>
    {%- endif -%}

    <div class="autorag-container" data-worker-url="{{ section.settings.worker_url }}">
      <div class="autorag-input-wrapper">
        <input
          type="text"
          id="AutoRagInput"
          class="autorag-input"
          placeholder="{{ section.settings.placeholder | default: 'Describe what you need...' }}"
          aria-label="{{ section.settings.placeholder | default: 'Search products' }}"
          autocomplete="off"
        >
        <div id="AutoRagLoader" class="autorag-loader hidden" aria-hidden="true">
          <span class="autorag-spinner"></span>
        </div>
        <button type="button" class="autorag-submit" aria-label="Search">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
          </svg>
        </button>
      </div>

      <div id="AutoRagResults" class="autorag-results">
        <div class="autorag-empty-state">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
          </svg>
          <p>{{ section.settings.empty_text | default: 'Ask a question like' }} <em>"{{ section.settings.example_query | default: 'Which welder is best for aluminum?' }}"</em></p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    var input = document.getElementById('AutoRagInput');
    var resultsContainer = document.getElementById('AutoRagResults');
    var loader = document.getElementById('AutoRagLoader');
    var container = document.querySelector('.autorag-container');
    var workerUrl = container ? container.dataset.workerUrl : '';

    // Debounce function
    function debounce(func, wait) {
      var timeout;
      return function() {
        var context = this;
        var args = arguments;
        clearTimeout(timeout);
        timeout = setTimeout(function() {
          func.apply(context, args);
        }, wait);
      };
    }

    async function performSearch(query) {
      if (!query || query.length < 2) {
        resultsContainer.innerHTML = getEmptyState();
        return;
      }

      // If no worker URL, fall back to native search
      if (!workerUrl) {
        console.warn('AutoRAG: No Worker URL provided. Falling back to native search.');
        window.location.href = '/search?q=' + encodeURIComponent(query);
        return;
      }

      loader.classList.remove('hidden');
      loader.setAttribute('aria-hidden', 'false');

      try {
        var res = await fetch(workerUrl + '?q=' + encodeURIComponent(query));
        var data = await res.json();

        renderResults(data.results);
      } catch (err) {
        console.error('AutoRAG Error:', err);
        resultsContainer.innerHTML = '<div class="autorag-error">' +
          '<p>Connection failed.</p>' +
          '<a href="/search?q=' + encodeURIComponent(query) + '" class="btn btn--outline">Try standard search</a>' +
          '</div>';
      } finally {
        loader.classList.add('hidden');
        loader.setAttribute('aria-hidden', 'true');
      }
    }

    function renderResults(items) {
      if (!items || items.length === 0) {
        resultsContainer.innerHTML = '<div class="autorag-no-results">' +
          '<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">' +
          '<circle cx="12" cy="12" r="10"></circle>' +
          '<line x1="15" y1="9" x2="9" y2="15"></line>' +
          '<line x1="9" y1="9" x2="15" y2="15"></line>' +
          '</svg>' +
          '<p>No AI matches found. Try different keywords.</p>' +
          '</div>';
        return;
      }

      var html = items.map(function(item) {
        var scorePercent = Math.round((item.score || 0) * 100);
        return '<a href="' + item.url + '" class="autorag-item">' +
          '<div class="autorag-item__image">' +
          (item.image ? '<img src="' + item.image + '" alt="' + (item.title || '') + '" loading="lazy" width="80">' : '') +
          '</div>' +
          '<div class="autorag-item__info">' +
          '<h4 class="autorag-item__title">' + (item.title || 'Product') + '</h4>' +
          '<div class="autorag-item__meta">' +
          '<span class="autorag-item__price">' + (item.price || '') + '</span>' +
          (scorePercent > 0 ? '<span class="autorag-item__score">Relevance: ' + scorePercent + '%</span>' : '') +
          '</div>' +
          (item.snippet ? '<p class="autorag-item__snippet">' + item.snippet + '</p>' : '') +
          '</div>' +
          '</a>';
      }).join('');

      resultsContainer.innerHTML = html;
    }

    function getEmptyState() {
      return '<div class="autorag-empty-state">' +
        '<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">' +
        '<circle cx="11" cy="11" r="8"></circle>' +
        '<line x1="21" y1="21" x2="16.65" y2="16.65"></line>' +
        '</svg>' +
        '<p>{{ section.settings.empty_text | default: "Ask a question like" }} <em>"{{ section.settings.example_query | default: "Which welder is best for aluminum?" }}"</em></p>' +
        '</div>';
    }

    // Event listeners
    input.addEventListener('input', debounce(function(e) {
      performSearch(e.target.value);
    }, 500));

    input.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        performSearch(input.value);
      }
    });

    document.querySelector('.autorag-submit').addEventListener('click', function() {
      performSearch(input.value);
    });
  });
</script>

{% schema %}
{
  "name": "AutoRAG Search",
  "tag": "section",
  "class": "section-autorag",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "AI-Powered Search"
    },
    {
      "type": "text",
      "id": "worker_url",
      "label": "Cloudflare Worker URL",
      "info": "The endpoint for your RAG Vector DB. Leave empty to use standard Shopify search."
    },
    {
      "type": "text",
      "id": "placeholder",
      "label": "Placeholder text",
      "default": "Describe what you need..."
    },
    {
      "type": "text",
      "id": "empty_text",
      "label": "Empty state text",
      "default": "Ask a question like"
    },
    {
      "type": "text",
      "id": "example_query",
      "label": "Example query",
      "default": "Which welder is best for aluminum?"
    },
    {
      "type": "header",
      "content": "Section padding"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding top",
      "default": 60
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding bottom",
      "default": 60
    }
  ],
  "presets": [
    {
      "name": "AutoRAG Search"
    }
  ]
}
{% endschema %}
