{%- comment -%}
  Product Schema (JSON-LD)
  Outputs Product structured data with offers, availability, and reviews
  Usage: {% render 'schema-product', product: product %}
{%- endcomment -%}

{%- liquid
  assign current_variant = product.selected_or_first_available_variant
  assign product_image = product.featured_image | default: product.images.first
-%}

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Product",
  "name": {{ product.title | json }},
  "url": {{ product.url | prepend: shop.url | json }},
  "description": {{ product.description | strip_html | truncate: 5000 | json }}
  {%- if product_image -%}
  ,"image": [
    {{ product_image | image_url: width: 1200 | json }}
    {%- for image in product.images offset: 1 limit: 4 -%}
    ,{{ image | image_url: width: 1200 | json }}
    {%- endfor -%}
  ]
  {%- endif -%}
  {%- if product.vendor != blank -%}
  ,"brand": {
    "@type": "Brand",
    "name": {{ product.vendor | json }}
  }
  {%- endif -%}
  {%- if product.sku != blank or current_variant.sku != blank -%}
  ,"sku": {{ current_variant.sku | default: product.sku | json }}
  {%- endif -%}
  {%- if current_variant.barcode != blank -%}
  ,"gtin": {{ current_variant.barcode | json }}
  {%- endif -%}
  ,"category": {{ product.type | json }}
  {%- if product.tags.size > 0 -%}
  ,"keywords": {{ product.tags | join: ', ' | json }}
  {%- endif -%}
  {%- if product.metafields.reviews.rating.value != blank -%}
  ,"aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": {{ product.metafields.reviews.rating.value.rating | json }},
    "reviewCount": {{ product.metafields.reviews.rating_count.value | default: 1 | json }},
    "bestRating": {{ product.metafields.reviews.rating.value.scale_max | default: 5 | json }},
    "worstRating": {{ product.metafields.reviews.rating.value.scale_min | default: 1 | json }}
  }
  {%- endif -%}
  ,"offers": {
    "@type": "Offer",
    "url": {{ product.url | prepend: shop.url | json }},
    "priceCurrency": {{ cart.currency.iso_code | json }},
    "price": {{ current_variant.price | divided_by: 100.0 | json }},
    "priceValidUntil": {{ 'now' | date: '%Y' | plus: 1 | append: '-12-31' | json }},
    "availability": "https://schema.org/{% if current_variant.available %}InStock{% else %}OutOfStock{% endif %}",
    "itemCondition": "https://schema.org/NewCondition",
    "seller": {
      "@type": "Organization",
      "name": {{ shop.name | json }}
    }
    {%- if current_variant.sku != blank -%}
    ,"sku": {{ current_variant.sku | json }}
    {%- endif -%}
    {%- if current_variant.compare_at_price > current_variant.price -%}
    ,"priceSpecification": {
      "@type": "UnitPriceSpecification",
      "price": {{ current_variant.price | divided_by: 100.0 | json }},
      "priceCurrency": {{ cart.currency.iso_code | json }},
      "referencePrice": {
        "@type": "UnitPriceSpecification", 
        "price": {{ current_variant.compare_at_price | divided_by: 100.0 | json }},
        "priceCurrency": {{ cart.currency.iso_code | json }}
      }
    }
    {%- endif -%}
  }
  {%- if product.variants.size > 1 -%}
  ,"hasVariant": [
    {%- for variant in product.variants -%}
    {
      "@type": "Product",
      "name": {{ variant.title | json }},
      "sku": {{ variant.sku | json }},
      "offers": {
        "@type": "Offer",
        "price": {{ variant.price | divided_by: 100.0 | json }},
        "priceCurrency": {{ cart.currency.iso_code | json }},
        "availability": "https://schema.org/{% if variant.available %}InStock{% else %}OutOfStock{% endif %}"
      }
    }{%- unless forloop.last -%},{%- endunless -%}
    {%- endfor -%}
  ]
  {%- endif -%}
  {%- comment -%} Add technical specifications if available {%- endcomment -%}
  {%- if product.metafields.specifications.technical.value -%}
  ,"additionalProperty": [
    {%- assign specs = product.metafields.specifications.technical.value -%}
    {%- for spec_category in specs -%}
      {%- assign category_name = spec_category[0] -%}
      {%- assign category_specs = spec_category[1] -%}
      {%- if category_specs.specifications -%}
        {%- for spec in category_specs.specifications -%}
        {
          "@type": "PropertyValue",
          "name": {{ spec.label | json }},
          "value": {{ spec.value | json }}
          {%- if spec.unit -%}
          ,"unitText": {{ spec.unit | json }}
          {%- endif -%}
        }{%- unless forloop.last -%},{%- endunless -%}
        {%- endfor -%}
        {%- unless forloop.last -%},{%- endunless -%}
      {%- endif -%}
    {%- endfor -%}
  ]
  {%- endif -%}
}
</script>
