{%- comment -%}
  Product Attachments Display
  Shows downloadable documentation from structured product metafields
  Supports category-based grouping, file icons, and access control

  Usage: 
    {% render 'product-attachments', 
       product: product,
       category: 'all|manuals|cad|certificates|safety',
       layout: 'grid|list',
       show_file_info: true|false
    %}

  Metafield namespace: attachments.files (JSON structure)
  Data structure: See config/schemas/attachment_schema.json
{%- endcomment -%}

{%- liquid
  # Parse parameters
  assign category_filter = category | default: 'all'
  assign layout_type = layout | default: 'list'
  assign show_file_info = show_file_info | default: true

  # Get attachment data from metafields
  assign attachment_data = product.metafields.attachments.files
  if attachment_data == blank
    assign attachment_data = product.metafields.attachments.data
  endif

  # Parse JSON data
  assign attachments = null
  assign categories = null
  
  if attachment_data != blank
    if attachment_data.value != blank
      assign parsed_data = attachment_data.value | parse_json
    else
      assign parsed_data = attachment_data | parse_json
    endif
    
    if parsed_data != blank
      assign attachments = parsed_data.files
      assign categories = parsed_data.categories
    endif
  endif

  # Check if we have any attachments
  assign has_attachments = false
  if attachments != blank and attachments.size > 0
    assign has_attachments = true
  endif

  # Filter attachments by category if specified
  assign filtered_attachments = attachments
  if category_filter != 'all' and attachments != blank
    assign filtered_attachments = attachments | where: 'category', category_filter
  endif

  # Sort categories by order
  assign sorted_categories = categories
  if categories != blank
    assign category_array = ''
    for cat_key in categories
      assign cat_data = categories[cat_key.first]
      assign cat_order = cat_data.order | default: 999
      assign category_array = category_array | append: cat_order | append: '|' | append: cat_key.first | append: ','
    endfor
    assign category_pairs = category_array | split: ','
    assign sorted_category_keys = category_pairs | sort | map: 'split: "|"' | map: 'last'
  endif

  # Settings
  assign open_behavior = settings.attachments_open_behavior | default: 'new_tab'
  assign show_descriptions = settings.attachments_show_descriptions | default: true
  assign show_file_sizes = settings.attachments_show_file_sizes | default: true
-%}

{%- if has_attachments -%}
  <div class="product-attachments product-attachments--{{ layout_type }}">
    <h3 class="attachments-heading">
      <svg class="attachments-heading__icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
        <polyline points="14 2 14 8 20 8"></polyline>
        <line x1="16" y1="13" x2="8" y2="13"></line>
        <line x1="16" y1="17" x2="8" y2="17"></line>
        <polyline points="10 9 9 9 8 9"></polyline>
      </svg>
      {{ 'products.attachments.heading' | t | default: 'Product Documentation' }}
    </h3>

    {%- if category_filter == 'all' and categories != blank -%}
      {%- comment -%} Display by categories {%- endcomment -%}
      {%- for cat_key in sorted_category_keys -%}
        {%- assign category_data = categories[cat_key] -%}
        {%- assign category_files = attachments | where: 'category', cat_key -%}
        
        {%- if category_files.size > 0 -%}
          <div class="attachment-category">
            <h4 class="attachment-category__title">
              {%- if category_data.icon -%}
                <span class="attachment-category__icon">
                  {%- render category_data.icon -%}
                </span>
              {%- endif -%}
              {{ category_data.name | default: cat_key }}
            </h4>
            
            <ul class="attachments-list attachments-list--{{ layout_type }}">
              {%- assign sorted_files = category_files | sort: 'order' -%}
              {%- for file in sorted_files -%}
                {%- render 'attachment-item', 
                    file: file, 
                    open_behavior: open_behavior,
                    show_file_info: show_file_info,
                    show_descriptions: show_descriptions,
                    show_file_sizes: show_file_sizes -%}
              {%- endfor -%}
            </ul>
          </div>
        {%- endif -%}
      {%- endfor -%}
    {%- else -%}
      {%- comment -%} Display filtered attachments {%- endcomment -%}
      <ul class="attachments-list attachments-list--{{ layout_type }}">
        {%- assign sorted_files = filtered_attachments | sort: 'order' -%}
        {%- for file in sorted_files -%}
          {%- render 'attachment-item', 
              file: file, 
              open_behavior: open_behavior,
              show_file_info: show_file_info,
              show_descriptions: show_descriptions,
              show_file_sizes: show_file_sizes -%}
        {%- endfor -%}
      </ul>
    {%- endif -%}
  </div>
{%- endif -%}
